<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’° Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø±</title>
  <style>
    body { font-family: "Cairo", sans-serif; margin:0; background:#f5f6fa; direction:rtl; font-size:20px; }
    header { background:#2c3e50; color:white; padding:25px; text-align:center; font-size:28px; }
    nav { display:flex; justify-content:center; gap:20px; background:#34495e; padding:15px; flex-wrap:wrap; }
    nav button { background:#1abc9c; border:none; color:white; padding:20px 40px; border-radius:12px; cursor:pointer; font-size:22px; font-weight:bold; }
    nav button:hover { background:#16a085; }
    section { display:none; max-width:1000px; margin:30px auto; background:white; padding:30px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.15); font-size:22px; }
    section.active { display:block; }
    label { display:block; margin-top:15px; font-weight:bold; font-size:22px; }
    input,button { margin:8px 0; padding:18px; border-radius:10px; border:1px solid #bbb; width:100%; box-sizing:border-box; font-size:22px; }
    button.action { background:#3498db; color:white; border:none; width:100%; font-size:24px; font-weight:bold; }
    button.action:hover { background:#2980b9; }
    table { width:100%; border-collapse:collapse; margin-top:20px; font-size:20px; }
    th,td { border:1px solid #ddd; padding:12px; text-align:center; }
    th { background:#ecf0f1; font-size:22px; }
    #scanner { display:none; margin:15px auto; width:300px; height:300px; border:3px solid #2980b9; }
    #lastScan { text-align:center; font-size:24px; margin-top:10px; font-weight:bold; color:#2c3e50; }
  </style>
</head>
<body>
  <header>ğŸ’° Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø±</header>
  <nav>
    <button onclick="showPage('sell')">ğŸ’µ Ø§Ù„Ø¨ÙŠØ¹</button>
    <button onclick="showPage('products')">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    <button onclick="showPage('profit')">ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</button>
    <button onclick="showPage('history')">ğŸ“Š Ø§Ù„Ø³Ø¬Ù„</button>
  </nav>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ¹ -->
  <section id="sell" class="active">
    <h2>ğŸ’µ Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬</h2>
    <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
    <input id="sellBarcode" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <button onclick="startScanner('sell')">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
    <input id="sellQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1">
    <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
    <input id="sellPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
    <button class="action" onclick="processTransaction()">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨ÙŠØ¹</button>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <section id="products">
    <h2>ğŸ›’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</label>
    <input id="pprice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©">
    <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
    <input id="pbarcode" placeholder="Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <button onclick="startScanner('product')">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
    <input id="pstock" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
    <button class="action" onclick="addOrUpdateProduct()">â• Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«</button>
    <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <table id="productsTable">
      <thead><tr><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
      <tbody></tbody>
    </table>
    <p style="font-weight:bold;font-size:22px;">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©: <span id="totalInventory">0</span></p>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø±Ø¨Ø­ -->
  <section id="profit">
    <h2>ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h2>
    <p>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalSales">0</span></p>
    <p>ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="totalCost">0</span></p>
    <p>âœ… ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: <span id="netProfit">0</span></p>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø³Ø¬Ù„ -->
  <section id="history">
    <h2>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
    <table id="historyTable">
      <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
  <div id="scanner"></div>
  <div id="lastScan"></div>
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <script>
    // ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAYiNmm_zMk2-nAOKolSWOCctJFvLmzDgY",
      authDomain: "dilovan-mobail.firebaseapp.com",
      databaseURL: "https://dilovan-mobail-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dilovan-mobail",
      storageBucket: "dilovan-mobail.appspot.com",
      messagingSenderId: "810315687480",
      appId: "1:810315687480:web:f124b761252e526dd1e8cd",
      measurementId: "G-ZM7LT9ETDK"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [];
    let transactions = [];
    let scannerMode = null;

    // ğŸ› ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    function loadProducts() {
      db.ref("products").on("value", snap => {
        products = snap.val() || [];
        renderProducts();
      });
    }

    function loadTransactions() {
      db.ref("transactions").on("value", snap => {
        transactions = snap.val() || [];
        renderTransactions();
      });
    }

    function saveProducts() { db.ref("products").set(products); }
    function saveTransactions() { db.ref("transactions").set(transactions); }

    // ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    function renderProducts() {
      const tbody = document.querySelector("#productsTable tbody");
      tbody.innerHTML = "";
      let total = 0;
      products.forEach(p => {
        total += p.price * p.stock;
        tbody.innerHTML += `<tr>
          <td>${p.barcode}</td>
          <td>${p.price}</td>
          <td>${p.stock}</td>
          <td><button onclick="editProduct('${p.barcode}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button onclick="deleteProduct('${p.barcode}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
        </tr>`;
      });
      document.getElementById("totalInventory").textContent = total.toFixed(2);
    }

    // â• Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªØ¬
    function addOrUpdateProduct() {
      const price = parseFloat(document.getElementById("pprice").value);
      const barcode = document.getElementById("pbarcode").value;
      const stock = parseInt(document.getElementById("pstock").value);
      if (!barcode) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯");

      let product = products.find(p => p.barcode === barcode);
      if (product) {
        product.price = price || product.price;
        product.stock += stock || 0;
      } else {
        products.push({ price, barcode, stock });
      }
      saveProducts();
    }

    // âœï¸ ØªØ¹Ø¯ÙŠÙ„
    function editProduct(barcode) {
      let p = products.find(p => p.barcode === barcode);
      if (!p) return;
      document.getElementById("pbarcode").value = p.barcode;
      document.getElementById("pprice").value = p.price;
      document.getElementById("pstock").value = p.stock;
      showPage("products");
    }

    // ğŸ—‘ï¸ Ø­Ø°Ù
    function deleteProduct(barcode) {
      products = products.filter(p => p.barcode !== barcode);
      saveProducts();
    }

    // ğŸ’µ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹
    function processTransaction() {
      const barcode = document.getElementById("sellBarcode").value;
      const qty = parseInt(document.getElementById("sellQty").value);
      const price = parseFloat(document.getElementById("sellPrice").value);
      let p = products.find(p => p.barcode === barcode);
      if (!p) return alert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      if (p.stock < qty) return alert("âŒ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ");

      p.stock -= qty;
      transactions.push({ type:"Ø¨ÙŠØ¹", barcode, qty, price,
                          total: price*qty, cost: p.price*qty,
                          date: new Date().toLocaleString() });
      saveProducts(); saveTransactions();
      alert("âœ” ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹");
    }

    // ğŸ“ˆ Ø§Ù„Ø±Ø¨Ø­
    function calcProfit() {
      let sales=0, cost=0;
      transactions.forEach(t => { sales+=t.price*t.qty; cost+=t.cost; });
      document.getElementById("totalSales").textContent = sales.toFixed(2);
      document.getElementById("totalCost").textContent = cost.toFixed(2);
      document.getElementById("netProfit").textContent = (sales-cost).toFixed(2);
    }

    // ğŸ—‚ï¸ Ø§Ù„Ø³Ø¬Ù„
    function renderTransactions() {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      transactions.forEach(t => {
        tbody.innerHTML += `<tr>
          <td>${t.type}</td><td>${t.barcode}</td><td>${t.qty}</td>
          <td>${t.price}</td><td>${t.total}</td><td>${t.date}</td>
        </tr>`;
      });
    }

    // ğŸ“„ Ø§Ù„ØµÙØ­Ø§Øª
    function showPage(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id==="products") renderProducts();
      if (id==="profit") calcProfit();
      if (id==="history") renderTransactions();
    }

    // ğŸ“· Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    function startScanner(mode) {
      scannerMode = mode;
      const scanner = document.getElementById("scanner");
      scanner.style.display = "block";
      document.getElementById("lastScan").textContent = "ğŸ“· Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ ...";

      if (Quagga.initialized) Quagga.stop();

      Quagga.init({
        inputStream: { type:"LiveStream", constraints:{ facingMode:"environment" }, target:scanner },
        decoder: { readers:["code_128_reader","ean_reader","ean_8_reader"] }
      }, err => { if(err){console.error(err);return;} Quagga.initialized = true; Quagga.start(); });

      Quagga.onDetected(data => {
        let code = data.codeResult.code;
        document.getElementById("beep").play();
        document.getElementById("lastScan").textContent = "âœ… Ø¢Ø®Ø± Ø¨Ø§Ø±ÙƒÙˆØ¯: " + code;
        if (scannerMode==="sell") document.getElementById("sellBarcode").value = code;
        if (scannerMode==="product") document.getElementById("pbarcode").value = code;
        Quagga.stop();
        scanner.style.display = "none";
      });
    }

    // ğŸš€ ØªØ´ØºÙŠÙ„
    loadProducts();
    loadTransactions();
  </script>
</body>
</html>
