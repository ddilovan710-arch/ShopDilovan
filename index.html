<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تجربة Firebase</title>
</head>
<body>
  <h2>📦 إضافة منتج جديد</h2>
  
  <input id="name" type="text" placeholder="اسم المنتج"><br><br>
  <input id="price" type="number" placeholder="السعر"><br><br>
  <input id="qty" type="number" placeholder="الكمية"><br><br>
  <button onclick="saveData()">💾 حفظ</button>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>

  <script>
    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAYiNmm_zMk2-nAOKolSWOCctJFvLmzDgY",
      authDomain: "dilovan-mobail.firebaseapp.com",
      databaseURL: "https://dilovan-mobail-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dilovan-mobail",
      storageBucket: "dilovan-mobail.appspot.com",
      messagingSenderId: "810315687480",
      appId: "1:810315687480:web:f124b761252e526dd1e8cd",
      measurementId: "G-ZM7LT9ETDK"
    };

    // تشغيل Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // دالة الحفظ
    function saveData() {
      let name = document.getElementById("name").value;
      let price = document.getElementById("price").value;
      let qty = document.getElementById("qty").value;

      if(name === "" || price === "" || qty === ""){
        alert("❌ يرجى ملء جميع الحقول");
        return;
      }

      // مرجع المنتجات
      const ref = db.ref("products").push();

      ref.set({
        name: name,
        price: price,
        quantity: qty,
        time: new Date().toISOString()
      }).then(() => {
        alert("✅ تم حفظ المنتج بنجاح!");
      }).catch((error) => {
        alert("⚠️ خطأ: " + error);
      });
    }
  </script>
</body>
</html>    // ➕ إضافة أو تحديث منتج
    function addOrUpdateProduct() {
      const price = parseFloat(document.getElementById("pprice").value);
      const barcode = document.getElementById("pbarcode").value;
      const stock = parseInt(document.getElementById("pstock").value);
      if (!barcode) return alert("❌ أدخل الباركود");

      let product = products.find(p => p.barcode === barcode);
      if (product) {
        product.price = price || product.price;
        product.stock += stock || 0;
      } else {
        products.push({ price, barcode, stock });
      }
      saveProducts();
    }

    // ✏️ تعديل
    function editProduct(barcode) {
      let p = products.find(p => p.barcode === barcode);
      if (!p) return;
      document.getElementById("pbarcode").value = p.barcode;
      document.getElementById("pprice").value = p.price;
      document.getElementById("pstock").value = p.stock;
      showPage("products");
    }

    // 🗑️ حذف
    function deleteProduct(barcode) {
      products = products.filter(p => p.barcode !== barcode);
      saveProducts();
    }

    // 💵 عملية بيع
    function processTransaction() {
      const barcode = document.getElementById("sellBarcode").value;
      const qty = parseInt(document.getElementById("sellQty").value);
      const price = parseFloat(document.getElementById("sellPrice").value);
      let p = products.find(p => p.barcode === barcode);
      if (!p) return alert("❌ المنتج غير موجود");
      if (p.stock < qty) return alert("❌ مخزون غير كافي");

      p.stock -= qty;
      transactions.push({ type:"بيع", barcode, qty, price,
                          total: price*qty, cost: p.price*qty,
                          date: new Date().toLocaleString() });
      saveProducts(); saveTransactions();
      alert("✔ تمت عملية البيع");
    }

    // 📈 الربح
    function calcProfit() {
      let sales=0, cost=0;
      transactions.forEach(t => { sales+=t.price*t.qty; cost+=t.cost; });
      document.getElementById("totalSales").textContent = sales.toFixed(2);
      document.getElementById("totalCost").textContent = cost.toFixed(2);
      document.getElementById("netProfit").textContent = (sales-cost).toFixed(2);
    }

    // 🗂️ السجل
    function renderTransactions() {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      transactions.forEach(t => {
        tbody.innerHTML += `<tr>
          <td>${t.type}</td><td>${t.barcode}</td><td>${t.qty}</td>
          <td>${t.price}</td><td>${t.total}</td><td>${t.date}</td>
        </tr>`;
      });
    }

    // 📄 الصفحات
    function showPage(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id==="products") renderProducts();
      if (id==="profit") calcProfit();
      if (id==="history") renderTransactions();
    }

    // 📷 الباركود
    function startScanner(mode) {
      scannerMode = mode;
      const scanner = document.getElementById("scanner");
      scanner.style.display = "block";
      document.getElementById("lastScan").textContent = "📷 جاري المسح ...";

      if (Quagga.initialized) Quagga.stop();

      Quagga.init({
        inputStream: { type:"LiveStream", constraints:{ facingMode:"environment" }, target:scanner },
        decoder: { readers:["code_128_reader","ean_reader","ean_8_reader"] }
      }, err => { if(err){console.error(err);return;} Quagga.initialized = true; Quagga.start(); });

      Quagga.onDetected(data => {
        let code = data.codeResult.code;
        document.getElementById("beep").play();
        document.getElementById("lastScan").textContent = "✅ آخر باركود: " + code;
        if (scannerMode==="sell") document.getElementById("sellBarcode").value = code;
        if (scannerMode==="product") document.getElementById("pbarcode").value = code;
        Quagga.stop();
        scanner.style.display = "none";
      });
    }

    // 🚀 تشغيل
    loadProducts();
    loadTransactions();
  </script>
</body>
</html>
